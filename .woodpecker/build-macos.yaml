when:
  - event: push
    branch: mcp-server

depends_on:
  - create-release

labels:
  platform: darwin/arm64

steps:
  - name: install-deps
    image: bash
    commands:
      - brew update
      - >-
        brew install
        autoconf
        automake
        pkg-config
        xa
        dos2unix
        gtk+3
        librsvg
        adwaita-icon-theme
        glew
        libmicrohttpd
        giflib
        libpng
        libvorbis
        flac
        lame
        mpg123
        libpcap
        libusb
        portaudio

  - name: build-gui
    image: bash
    commands:
      - cd vice
      - rm -rf build-gui build-headless
      - rm -f src/config.h
      - find . -name config.status -exec rm -f {} +
      - ./src/buildtools/genvicedate_h.sh
      # Fix autotools timestamps: git clone gives all files same mtime,
      # causing make to think generated files need regeneration
      - sleep 1 && find . -name aclocal.m4 -exec touch {} +
      - sleep 1 && find . -name configure -exec touch {} + && find . -name config.h.in -exec touch {} +
      - find . -name Makefile.in -exec touch {} +
      - mkdir -p build-gui && cd build-gui
      - >-
        ../configure
        --enable-option-checking=fatal
        --enable-gtk3ui
        --enable-mcp-server
        --enable-cpuhistory
        --enable-ethernet
        --enable-midi
        --enable-parsid
        --disable-arch
        --disable-pdf-docs
        --disable-html-docs
        --disable-openmp
        --with-fastsid
        --with-flac
        --with-gif
        --with-lame
        --with-libcurl
        --with-mpg123
        --with-png
        --with-portaudio
        --with-resid
        --with-vorbis
      - make -j$$(sysctl -n hw.ncpu) -s
      - DEPS_PREFIX=$$(brew --prefix) make bindistzip
      - cd ../..
      - git fetch --tags
      - VERSION=$$(bash scripts/compute-version.sh --current)
      - |
        cd vice/build-gui
        DMG_FILE=$$(ls *.dmg 2>/dev/null | head -1 || true)
        ZIP_FILE=$$(ls *.zip 2>/dev/null | head -1 || true)
        if [ -n "$${DMG_FILE}" ]; then
          cp "$${DMG_FILE}" "../../$${VERSION}-macos-arm64-gui.dmg"
        elif [ -n "$${ZIP_FILE}" ]; then
          cp "$${ZIP_FILE}" "../../$${VERSION}-macos-arm64-gui.zip"
        else
          echo "ERROR: No package artifact found" && exit 1
        fi

  - name: build-headless
    image: bash
    commands:
      - cd vice
      - rm -rf build-headless
      - mkdir -p build-headless && cd build-headless
      - >-
        ../configure
        --enable-option-checking=fatal
        --enable-headlessui
        --enable-mcp-server
        --enable-cpuhistory
        --enable-ethernet
        --enable-midi
        --enable-parsid
        --disable-arch
        --disable-pdf-docs
        --disable-html-docs
        --disable-openmp
        --with-fastsid
        --with-flac
        --with-gif
        --with-lame
        --with-libcurl
        --with-mpg123
        --with-png
        --with-portaudio
        --with-resid
        --with-vorbis
      - make -j$$(sysctl -n hw.ncpu) -s
      - make DESTDIR=$${PWD}/install-tree install-strip
      - cd ../..
      - git fetch --tags
      - VERSION=$$(bash scripts/compute-version.sh --current)
      - cd vice/build-headless/install-tree
      - find . -type f -exec shasum -a 256 {} + > SHA256SUMS
      - zip -r "../../../$${VERSION}-macos-arm64-headless.zip" .
      - cd ../../..

  - name: upload
    image: bash
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - git fetch --tags
      - VERSION=$$(bash scripts/compute-version.sh --current)
      - |
        for f in $${VERSION}-macos-arm64-*.dmg $${VERSION}-macos-arm64-*.zip; do
          [ -f "$${f}" ] && gh release upload "$${VERSION}" "$${f}" --repo "$${CI_REPO}" --clobber
        done
